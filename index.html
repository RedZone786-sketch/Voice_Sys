<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Advanced Voice Engine</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body style="background:transparent; margin:0; overflow:hidden;">
    <div id="remote-audios"></div>
    <script>
        let database, myUid, localStream;
        const peers = {};
        const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        // Advanced Constraints for Vocal Focus & Noise Cancellation
        const audioConstraints = {
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                // Google-specific constraints for Android WebViews
                googEchoCancellation: true,
                googAutoGainControl: true,
                googNoiseSuppression: true,
                googHighpassFilter: true, 
                googTypingNoiseDetection: true,
                channelCount: 1,
                sampleRate: 44100
            }
        };

        window.initVoice = function(configStr, uid) {
            try {
                firebase.initializeApp(JSON.parse(configStr));
                database = firebase.database();
                myUid = uid;
                setupIncomingListener();
                startLocalStream();
            } catch(e) { if(window.AndroidBridge) AndroidBridge.log("Init Error"); }
        };

        window.toggleMic = function(isMuted) {
            if (localStream && localStream.getAudioTracks()[0]) {
                localStream.getAudioTracks()[0].enabled = !isMuted;
            }
        };

        async function startLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia(audioConstraints);
                if(window.AndroidBridge) AndroidBridge.log("Noise Cancellation Enabled");
            } catch (e) { 
                if(window.AndroidBridge) AndroidBridge.log("Mic Permission Denied"); 
            }
        }

        function setupIncomingListener() {
            database.ref(`voiceSignaling/${myUid}`).on('child_added', async (snap) => {
                const data = snap.val();
                if (data.type === 'offer') { handleOffer(data.offer, data.from); snap.ref.remove(); }
            });
        }

        window.connectToUser = async function(remoteUid) {
            if (peers[remoteUid]) return;
            const pc = createPeerConnection(remoteUid);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            database.ref(`voiceSignaling/${remoteUid}`).push({ type: 'offer', from: myUid, offer: offer });
        };

        async function handleOffer(offer, remoteUid) {
            const pc = createPeerConnection(remoteUid);
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            database.ref(`voiceSignaling/${remoteUid}`).push({ type: 'answer', from: myUid, answer: answer });
        }

        function createPeerConnection(remoteUid) {
            const pc = new RTCPeerConnection(iceServers);
            peers[remoteUid] = pc;
            if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            pc.ontrack = (e) => {
                let a = document.getElementById(`audio-${remoteUid}`) || document.createElement('audio');
                a.id = `audio-${remoteUid}`; a.autoplay = true; a.srcObject = e.streams[0];
                // Set volume boost for clear voice
                a.volume = 1.0;
                document.getElementById('remote-audios').appendChild(a);
            };

            pc.onicecandidate = (e) => { 
                if (e.candidate) database.ref(`voiceIce/${remoteUid}/${myUid}`).push(e.candidate.toJSON()); 
            };

            database.ref(`voiceIce/${myUid}/${remoteUid}`).on('child_added', s => pc.addIceCandidate(new RTCIceCandidate(s.val())));
            
            database.ref(`voiceSignaling/${myUid}`).on('child_added', async (s) => {
                const d = s.val(); 
                if (d.type === 'answer' && d.from === remoteUid) {
                    await pc.setRemoteDescription(new RTCSessionDescription(d.answer)); 
                    s.ref.remove();
                }
            });
            return pc;
        }
    </script>
</body>
</html>

