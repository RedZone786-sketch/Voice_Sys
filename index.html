<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Clean Voice Engine</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background: #000; color: #2ea043; font-family: monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        #status { font-size: 12px; text-align: center; color: #00ff00; }
    </style>
</head>
<body>
    <div id="status">FILTERING ACTIVE: NOISE CANCELLATION ON</div>
    <div id="remote-audios"></div>

    <script>
        let database;
        let myUid;
        let localStream;
        const peers = {};
        const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        // Optimized Audio Constraints for Noise Cancellation
        const audioConstraints = {
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                channelCount: 1,
                sampleRate: 44100
            }
        };

        window.initVoice = function(configStr, uid) {
            try {
                firebase.initializeApp(JSON.parse(configStr));
                database = firebase.database();
                myUid = uid;
                setupIncomingListener();
                startLocalStream();
            } catch (e) { console.error(e); }
        };

        async function startLocalStream() {
            try {
                // Requesting stream with Noise Cancellation constraints
                localStream = await navigator.mediaDevices.getUserMedia(audioConstraints);
                if(window.AndroidBridge) AndroidBridge.log("Mic Active (Noise Cancel On)");
            } catch (e) {
                if(window.AndroidBridge) AndroidBridge.log("Mic Error: " + e.message);
            }
        }

        function setupIncomingListener() {
            database.ref(`voiceSignaling/${myUid}`).on('child_added', async (snapshot) => {
                const data = snapshot.val();
                if (data.type === 'offer') {
                    handleOffer(data.offer, data.from);
                    snapshot.ref.remove();
                }
            });
        }

        window.connectToUser = async function(remoteUid) {
            if (peers[remoteUid]) return;
            const pc = createPeerConnection(remoteUid);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            database.ref(`voiceSignaling/${remoteUid}`).push({ type: 'offer', from: myUid, offer: offer });
        };

        async function handleOffer(offer, remoteUid) {
            const pc = createPeerConnection(remoteUid);
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            database.ref(`voiceSignaling/${remoteUid}`).push({ type: 'answer', from: myUid, answer: answer });
        }

        function createPeerConnection(remoteUid) {
            const pc = new RTCPeerConnection(iceServers);
            peers[remoteUid] = pc;
            if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = (e) => {
                let audio = document.getElementById(`audio-${remoteUid}`) || document.createElement('audio');
                audio.id = `audio-${remoteUid}`;
                audio.autoplay = true;
                audio.srcObject = e.streams[0];
                document.getElementById('remote-audios').appendChild(audio);
            };

            pc.onicecandidate = (e) => {
                if (e.candidate) database.ref(`voiceIce/${remoteUid}/${myUid}`).push(e.candidate.toJSON());
            };

            database.ref(`voiceIce/${myUid}/${remoteUid}`).on('child_added', s => pc.addIceCandidate(new RTCIceCandidate(s.val())));
            
            database.ref(`voiceSignaling/${myUid}`).on('child_added', async (s) => {
                const d = s.val();
                if (d.type === 'answer' && d.from === remoteUid) {
                    await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                    s.ref.remove();
                }
            });

            return pc;
        }
    </script>
</body>
</html>

